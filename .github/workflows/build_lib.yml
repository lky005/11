name: Compile HarmonyOS Lib

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup HarmonyOS NDK (6.0.0.1 Newest)
      run: |
        echo "Downloading SDK 6.0.0.1 (3.0GB)..."
        # 保持进度条显示
        wget --progress=bar:force:noscroll https://repo.huaweicloud.com/openharmony/os/6.0.0.1-Release/ohos-sdk-windows_linux-public.tar.gz
        
        echo "Extracting SDK..."
        mkdir temp_sdk
        tar -xzf ohos-sdk-windows_linux-public.tar.gz -C temp_sdk
        
        NATIVE_ZIP=$(find temp_sdk -name "native-linux-x64-*.zip" | head -n 1)
        
        if [ -z "$NATIVE_ZIP" ]; then
          echo "Error: Could not find native-linux-x64-*.zip"
          find temp_sdk -maxdepth 3
          exit 1
        fi
        
        echo "Found Native Zip: $NATIVE_ZIP"
        
        mkdir -p ohos-sdk
        unzip -q "$NATIVE_ZIP" -d ohos-sdk
        
        echo "OHOS_NDK_HOME=$(pwd)/ohos-sdk/native" >> $GITHUB_ENV

    - name: Check Environment
      run: |
        echo "Checking CMake Version..."
        cmake --version

    - name: Build C++ (.so)
      run: |
        mkdir build_cpp
        cd build_cpp
        
        TOOLCHAIN_FILE=$(find $OHOS_NDK_HOME -name "ohos.toolchain.cmake" | head -n 1)
        echo "Using Toolchain: $TOOLCHAIN_FILE"
        
        # --- 核心修复：去掉了 /usr/bin/ 前缀，直接用 cmake ---
        cmake \
          -DOHOS_STL=c++_shared \
          -DCMAKE_TOOLCHAIN_FILE="$TOOLCHAIN_FILE" \
          -DCMAKE_BUILD_TYPE=Release \
          -DOHOS_ARCH=arm64-v8a \
          ../entry/src/main/cpp
        
        make
        
        mkdir -p ../output/libs/arm64-v8a
        find . -name "libmylib.so" -exec cp {} ../output/libs/arm64-v8a/ \;

    - name: Build Java (.jar)
      run: |
        mkdir build_java
        javac -d build_java entry/src/main/java/com/example/mylib/MyNativeLib.java
        cd build_java
        jar cvf ../output/mylib-java.jar .

    - name: Upload Result
      uses: actions/upload-artifact@v4
      with:
        name: Lib-Product
        path: output/
